# tfmodule-google-cloud-sql-postgresql

Terraform module for provisioning and managing Google Cloud SQL PostgreSQL instances with comprehensive support for high availability, replication, security, and enterprise features.

## Features

- **Multi-version PostgreSQL Support** - PostgreSQL 9.6, 14, 15, 16, and 17
- **High Availability** - Regional HA with automatic failover and read replicas
- **Advanced Security** - IAM authentication, CMEK encryption, SSL/TLS, and Private Service Connect
- **Automated Backups** - Point-in-time recovery, automated backups, and transaction log retention
- **Enterprise Features** - Data cache, Query Insights, ML integration, and Dataplex integration
- **Flexible Networking** - Private VPC, authorized networks, and PSC configuration
- **User Management** - Built-in and IAM users with password policies and validation
- **Read Replicas** - Cross-region replicas with independent configuration
- **KMS Integration** - Autokey support and custom encryption key management

## Usage

### Basic Example

```hcl
module "postgresql" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"

  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "my-postgres-instance"
  database_version = "16"
  tier             = "db-custom-2-7680"

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc"
  }
}
```

### High Availability with Automated Backups

```hcl
module "postgresql_ha" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-ha-instance"
  database_version = "16"
  tier             = "db-custom-4-15360"
  
  # Regional HA configuration
  availability_type = "REGIONAL"
  zone              = "us-central1-a"
  secondary_zone    = "us-central1-b"

  # Backup configuration
  backup_configuration = {
    enabled                        = true
    start_time                     = "02:00"
    location                       = "us"
    point_in_time_recovery_enabled = true
    transaction_log_retention_days = "7"
    retained_backups               = 30
    retention_unit                 = "COUNT"
  }

  # Deletion protection
  deletion_protection         = true
  deletion_protection_enabled = true

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc"
  }
}
```

### Private Instance with Read Replicas

```hcl
module "postgresql_with_replicas" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-primary"
  database_version = "16"
  tier             = "db-custom-4-15360"
  
  # Network configuration
  ip_configuration = {
    ipv4_enabled                                  = false
    private_network                               = "projects/my-project-id/global/networks/my-vpc"
    enable_private_path_for_google_cloud_services = true
    ssl_mode                                      = "ENCRYPTED_ONLY"
  }

  # Read replicas
  read_replicas = [
    {
      name              = "replica-1"
      tier              = "db-custom-4-15360"
      zone              = "us-central1-b"
      disk_type         = "PD_SSD"
      disk_autoresize   = true
      availability_type = "ZONAL"
      
      ip_configuration = {
        ipv4_enabled    = false
        private_network = "projects/my-project-id/global/networks/my-vpc"
        ssl_mode        = "ENCRYPTED_ONLY"
      }
      
      user_labels = {
        role        = "replica"
        environment = "production"
      }
    },
    {
      name              = "replica-2"
      tier              = "db-custom-2-7680"
      zone              = "us-east1-c"
      disk_type         = "PD_SSD"
      encryption_key_name = "projects/my-project/locations/us-east1/keyRings/my-ring/cryptoKeys/my-key"
      
      ip_configuration = {
        ipv4_enabled    = false
        private_network = "projects/my-project-id/global/networks/my-vpc-east"
        ssl_mode        = "ENCRYPTED_ONLY"
      }
      
      user_labels = {
        role        = "replica"
        region      = "us-east1"
      }
    }
  ]

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  user_labels = {
    role        = "primary"
    environment = "production"
  }
}
```

### Enterprise Edition with Advanced Features

```hcl
module "postgresql_enterprise" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-enterprise"
  database_version = "16"
  tier             = "db-perf-optimized-N-8"
  edition          = "ENTERPRISE_PLUS"
  
  # Data cache for improved performance
  data_cache_enabled = true
  
  # Query Insights
  insights_config = {
    query_plans_per_minute  = 10
    query_string_length     = 2048
    record_application_tags = true
    record_client_address   = true
  }
  
  # ML Integration
  enable_google_ml_integration = true
  
  # Database integration roles
  database_integration_roles = [
    "roles/aiplatform.user",
    "roles/storage.objectViewer"
  ]

  # Password validation policy
  password_validation_policy_config = {
    min_length                  = "12"
    complexity                  = "COMPLEXITY_DEFAULT"
    reuse_interval              = "10"
    disallow_username_substring = "true"
    password_change_interval    = "90d"
  }

  password_policy_config = {
    allowed_failed_attempts      = 3
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "60d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc"
    ssl_mode        = "TRUSTED_CLIENT_CERTIFICATE_REQUIRED"
  }
}
```

### Multiple Databases and Users

```hcl
module "postgresql_multi_db" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-multi-db"
  database_version = "16"
  tier             = "db-custom-2-7680"

  # Default database and user
  enable_default_db   = true
  db_name             = "application_db"
  enable_default_user = true
  user_name           = "app_user"

  # Additional databases
  additional_databases = [
    {
      name      = "analytics_db"
      charset   = "UTF8"
      collation = "en_US.UTF8"
    },
    {
      name      = "reporting_db"
      charset   = "UTF8"
      collation = "en_US.UTF8"
    }
  ]

  # Additional users with auto-generated passwords
  additional_users = [
    {
      name            = "analytics_user"
      password        = ""
      random_password = true
    },
    {
      name            = "reporting_user"
      password        = ""
      random_password = true
    },
    {
      name            = "admin_user"
      password        = "SecurePassword123!"
      random_password = false
    }
  ]

  # IAM users
  iam_users = [
    {
      id    = "serviceaccount1"
      email = "sa-database@my-project-id.iam.gserviceaccount.com"
    },
    {
      id    = "user1"
      email = "developer@example.com"
      type  = "CLOUD_IAM_USER"
    }
  ]

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc"
  }
}
```

### CMEK Encryption with KMS Autokey

```hcl
module "postgresql_encrypted" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-encrypted"
  database_version = "16"
  tier             = "db-custom-2-7680"

  # KMS Autokey configuration
  use_autokey             = true
  create_kms_key_handle   = true
  kms_key_handle_name     = "postgres-encrypted-key"

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc"
  }
}

# Alternative: Using custom CMEK key
module "postgresql_cmek" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-cmek"
  database_version = "16"
  tier             = "db-custom-2-7680"

  # Custom encryption key
  encryption_key_name = "projects/my-project/locations/us-central1/keyRings/my-keyring/cryptoKeys/my-key"

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc"
  }
}
```

### Private Service Connect Configuration

```hcl
module "postgresql_psc" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-psc"
  database_version = "16"
  tier             = "db-custom-2-7680"

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc"
    
    # PSC configuration
    psc_enabled = true
    psc_allowed_consumer_projects = [
      "my-project-id",
      "consumer-project-1",
      "consumer-project-2"
    ]
    
    ssl_mode = "ENCRYPTED_ONLY"
  }

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }
}
```

### Maintenance Window and Deny Period

```hcl
module "postgresql_maintenance" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-maintenance"
  database_version = "16"
  tier             = "db-custom-2-7680"

  # Maintenance window (Sunday at 2 AM)
  maintenance_window_day          = 7
  maintenance_window_hour         = 2
  maintenance_window_update_track = "stable"

  # Deny maintenance during peak season
  deny_maintenance_period = [
    {
      start_date = "2024-11-01"
      end_date   = "2024-12-31"
      time       = "00:00:00"
    }
  ]

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc"
  }
}
```

### Public Instance with Authorized Networks

```hcl
module "postgresql_public" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-public"
  database_version = "16"
  tier             = "db-custom-2-7680"

  ip_configuration = {
    ipv4_enabled = true
    ssl_mode     = "TRUSTED_CLIENT_CERTIFICATE_REQUIRED"
    
    authorized_networks = [
      {
        name  = "office-network"
        value = "203.0.113.0/24"
      },
      {
        name  = "vpn-gateway"
        value = "198.51.100.10/32"
      },
      {
        name           = "temporary-access"
        value          = "192.0.2.50/32"
        expiration_time = "2024-12-31T23:59:59Z"
      }
    ]
  }

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }
}
```

### Disaster Recovery Configuration

```hcl
# Primary instance in us-central1
module "postgresql_primary" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-central1"
  name             = "postgres-dr-primary"
  database_version = "16"
  tier             = "db-custom-4-15360"
  availability_type = "REGIONAL"

  # Configure DR replica
  failover_dr_replica_name = "my-project-id:postgres-dr-secondary"

  backup_configuration = {
    enabled                        = true
    start_time                     = "03:00"
    point_in_time_recovery_enabled = true
    transaction_log_retention_days = "7"
  }

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc-central"
  }
}

# DR secondary instance in us-east1
module "postgresql_secondary" {
  source = "github.com/xlsmartenterprise/tfmodule-google-cloud-sql-postgresql"


  project_id       = "my-project-id"
  region           = "us-east1"
  name             = "postgres-dr-secondary"
  database_version = "16"
  tier             = "db-custom-4-15360"
  
  # Link to primary instance
  master_instance_name = module.postgresql_primary.instance_name
  
  # Encryption key required for cross-region replica
  encryption_key_name = "projects/my-project/locations/us-east1/keyRings/dr-keyring/cryptoKeys/dr-key"

  password_policy_config = {
    allowed_failed_attempts      = 5
    enable_failed_attempts_check = true
    enable_password_verification = true
    password_expiration_duration = "30d"
  }

  ip_configuration = {
    ipv4_enabled    = false
    private_network = "projects/my-project-id/global/networks/my-vpc-east"
  }
}
```

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| project_id | The project ID to manage the Cloud SQL resources | `string` | n/a | yes |
| region | The region of the Cloud SQL resources | `string` | `"us-central1"` | no |
| name | The name of the Cloud SQL instance | `string` | n/a | yes |
| database_version | The database version to use. Can be 9_6, 14, 15, 16, 17 | `string` | n/a | yes |
| password_policy_config | Configure password policy for SQL users | `object` | n/a | yes |
| tier | The tier for the Cloud SQL instance | `string` | `"db-f1-micro"` | no |
| edition | The edition of the Cloud SQL instance (ENTERPRISE or ENTERPRISE_PLUS) | `string` | `null` | no |
| availability_type | The availability type (ZONAL or REGIONAL) | `string` | `"ZONAL"` | no |
| zone | The zone for the Cloud SQL instance | `string` | `null` | no |
| secondary_zone | The preferred zone for the replica instance | `string` | `null` | no |
| activation_policy | The activation policy (ALWAYS, NEVER, ON_DEMAND) | `string` | `"ALWAYS"` | no |
| deletion_protection | Block Terraform from deleting a SQL Instance | `bool` | `true` | no |
| deletion_protection_enabled | Enables protection across all surfaces | `bool` | `false` | no |
| disk_size | The disk size for the Cloud SQL instance (GB) | `string` | `10` | no |
| disk_type | The disk type for the Cloud SQL instance | `string` | `"PD_SSD"` | no |
| disk_autoresize | Configuration to increase storage size | `bool` | `true` | no |
| disk_autoresize_limit | Maximum size for auto increase | `number` | `0` | no |
| pricing_plan | The pricing plan for the instance | `string` | `"PER_USE"` | no |
| maintenance_version | The current software version on the instance | `string` | `null` | no |
| maintenance_window_day | Day of week for maintenance (1-7) | `number` | `1` | no |
| maintenance_window_hour | Hour of day for maintenance (0-23) | `number` | `0` | no |
| maintenance_window_update_track | Maintenance update track (canary or stable) | `string` | `"canary"` | no |
| deny_maintenance_period | Deny maintenance periods | `list(object)` | `[]` | no |
| database_flags | Database flags for the instance | `list(object)` | `[]` | no |
| user_labels | User labels for resource organization | `map(string)` | `{}` | no |
| backup_configuration | Backup configuration settings | `object` | `{}` | no |
| ip_configuration | IP configuration for the instances | `object` | `{}` | no |
| insights_config | Query Insights configuration | `object` | `null` | no |
| password_validation_policy_config | Password validation policy settings | `object` | `null` | no |
| enable_default_db | Enable creation of default database | `bool` | `true` | no |
| db_name | Name of the default database | `string` | `"default"` | no |
| db_charset | Charset for the default database | `string` | `""` | no |
| db_collation | Collation for the default database | `string` | `""` | no |
| enable_default_user | Enable creation of default user | `bool` | `true` | no |
| user_name | Name of the default user | `string` | `"default"` | no |
| user_password | Password for the default user | `string` | `""` | no |
| root_password | Initial root password during creation | `string` | `null` | no |
| additional_databases | List of additional databases | `list(object)` | `[]` | no |
| additional_users | List of additional users | `list(object)` | `[]` | no |
| iam_users | List of IAM users to be created | `list(object)` | `[]` | no |
| database_deletion_policy | Deletion policy for databases | `string` | `null` | no |
| user_deletion_policy | Deletion policy for users | `string` | `null` | no |
| read_replicas | List of read replicas to create | `list(object)` | `[]` | no |
| read_replica_name_suffix | Suffix to add to read replica names | `string` | `""` | no |
| read_replica_deletion_protection | Block Terraform from deleting replica instances | `bool` | `false` | no |
| read_replica_deletion_protection_enabled | Protection for replica instances | `bool` | `false` | no |
| master_instance_name | Name of master instance for failover replicas | `string` | `null` | no |
| failover_dr_replica_name | Disaster recovery replica identifier | `string` | `null` | no |
| instance_type | Type of the instance | `string` | `"CLOUD_SQL_INSTANCE"` | no |
| random_instance_name | Sets random suffix at the end of instance name | `bool` | `false` | no |
| follow_gae_application | Google App Engine application to remain near | `string` | `null` | no |
| data_cache_enabled | Enable data cache for ENTERPRISE_PLUS | `bool` | `false` | no |
| connector_enforcement | Enforce use of connector library | `bool` | `false` | no |
| enable_google_ml_integration | Enable database ML integration | `bool` | `false` | no |
| enable_dataplex_integration | Enable database Dataplex integration | `bool` | `false` | no |
| database_integration_roles | Roles required for GCP service integration | `list(string)` | `[]` | no |
| encryption_key_name | Full path to encryption key for CMEK | `string` | `null` | no |
| use_autokey | Enable KMS Autokey for CMEK | `bool` | `false` | no |
| create_kms_key_handle | Create new KMS key handle | `bool` | `true` | no |
| kms_key_handle_name | Key handle name | `string` | `null` | no |
| retain_backups_on_delete | Retain backups after instance deletion | `bool` | `false` | no |
| enable_random_password_special | Enable special characters in passwords | `bool` | `false` | no |
| create_timeout | Timeout for database creates | `string` | `"30m"` | no |
| update_timeout | Timeout for database updates | `string` | `"30m"` | no |
| delete_timeout | Timeout for database deletes | `string` | `"30m"` | no |
| module_depends_on | List of module dependencies | `list(any)` | `[]` | no |

## Outputs

| Name | Description |
|------|-------------|
| instance_name | The instance name for the primary instance |
| instance_connection_name | Connection name for Cloud SQL Proxy |
| public_ip_address | First public IPv4 address assigned |
| private_ip_address | First private IPv4 address assigned |
| instance_ip_address | All IPv4 addresses assigned |
| instance_first_ip_address | First IPv4 address of addresses assigned |
| instance_self_link | URI of the primary instance |
| instance_server_ca_cert | CA certificate for SSL connections (sensitive) |
| instance_service_account_email_address | Service account email for primary instance |
| instance_psc_attachment | PSC service attachment link |
| dns_name | DNS name of the instance endpoint |
| read_replica_instance_names | Instance names for read replicas |
| replicas_instance_connection_names | Connection names for replica instances |
| replicas_instance_first_ip_addresses | First IPv4 addresses for replicas |
| replicas_instance_self_links | URIs of replica instances |
| replicas_instance_server_ca_certs | CA certificates for replicas (sensitive) |
| replicas_instance_service_account_email_addresses | Service account emails for replicas |
| replicas_instance_psc_attachments | PSC attachment links for replicas |
| generated_user_password | Auto-generated default user password (sensitive) |
| additional_users | List of additional users with passwords (sensitive) |
| additional_user_passwords_map | Map of username to password (sensitive) |
| iam_users | List of IAM users with access |
| primary | Complete primary instance resource (sensitive) |
| replicas | List of replica instance resources (sensitive) |
| instances | All instance resources combined (sensitive) |
| env_vars | Exported environment variables |
| apphub_service_uri | Service URI for AppHub integration |

## Requirements

| Name | Version |
|------|---------|
| terraform | >= 1.5.0 |
| google | >= 7.0.0, < 8.0.0 |
| google-beta | >= 7.0.0, < 8.0.0 |

## Changelog

See [CHANGELOG.md](./CHANGELOG.md) for version history and changes.